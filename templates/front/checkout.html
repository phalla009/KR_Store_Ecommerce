{% extends 'front/master.html' %}

{% block content %}
<div class="container my-2" data-aos="zoom-in" data-aos-delay="100">
    <h2 class="mb-4 text-center">
      <i class="fa fa-credit-card"></i> Checkout
    </h2>

    <div class="row">
    <!-- LEFT: Shipping Info -->
    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                Shipping Address
            </div>
            <div class="card-body">
                <form id="checkoutForm">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>First Name</label>
                            <input type="text" class="form-control" name="first_name" placeholder="John" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Last Name</label>
                            <input type="text" class="form-control" name="last_name" placeholder="Doe" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" class="form-control" name="address" placeholder="1234 Main St" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-5">
                            <label>City</label>
                            <input type="text" class="form-control" name="city" placeholder="Phnom Penh" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label>Country</label>
                            <select class="form-control" name="country" required>
                                <option selected disabled>Choose...</option>
                                <option>Cambodia</option>
                                <option>Vietnam</option>
                                <option>Laos</option>
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Zip</label>
                            <input type="text" class="form-control" name="zip" placeholder="12000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" name="email" placeholder="example@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" class="form-control" name="phone" placeholder="+855 12 345 678" required>
                    </div>
                   <button class="btn btn-primary btn-block btn-lg mt-3 btn-rounded" type="submit">
                      Place Order <i class="fa fa-check"></i>
                    </button>
                    <p class="mt-3 text-center text-muted" style="font-size: 0.95rem;">
                        By placing your order, you agree to our
                        <a href="#" class="text-primary">Terms & Conditions</a>.
                    </p>
                </form>
            </div>
        </div>
    </div>
    <!-- RIGHT: Order Summary -->
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                Order Summary
            </div>
            <div class="card-body">
                <ul id="cart_list_tbody" class="list-group mb-3"></ul>
                <h5 class="d-flex justify-content-between">
                    <span>Total (USD)</span>
                    <span id="label_total_usd" class="text-success">$0.00</span>
                </h5>
                <h5 class="d-flex justify-content-between">
                    <span>Total (KHR)</span>
                    <span id="label_total_khr" class="text-success">៛0.00</span>
                </h5>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" style="position: relative; z-index: 1050;">
    <div id="toastContainer" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);"></div>
</div>

<script>
// Toast function
function showToast(message, type = "success") {
    const toastId = `toast-${Date.now()}`;
    const bg = type === "success" ? "bg-success" : "bg-danger";
    const toastHTML = `
        <div id="${toastId}" class="toast ${bg} text-white" role="alert" data-delay="3000" style="min-width:250px;">
            <div class="toast-body">${message}</div>
        </div>
    `;
    document.getElementById("toastContainer").insertAdjacentHTML("beforeend", toastHTML);
    const toastEl = document.getElementById(toastId);
    $(toastEl).toast("show").on("hidden.bs.toast", () => toastEl.remove());
}

// Load cart from localStorage
let cart_list = JSON.parse(localStorage.getItem('cart_list') ?? '[]');
let cart_list_tbody = document.getElementById('cart_list_tbody');
let label_total_usd = document.getElementById('label_total_usd');
let label_total_khr = document.getElementById('label_total_khr');
let cart = document.getElementById('cart');
if (cart) cart.innerText = `Cart(${cart_list.length})`;

// Render cart summary
function renderCartSummary() {
    cart_list_tbody.innerHTML = '';
    let totalUSD = 0;
    cart_list.forEach(item => {
        let itemTotal = item.qty * item.price;
        totalUSD += itemTotal;
        cart_list_tbody.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${item.title}
                <span>x${item.qty}</span>
                <span>$${itemTotal.toFixed(2)}</span>
            </li>
        `;
    });
    label_total_usd.textContent = `$${totalUSD.toFixed(2)}`;
    label_total_khr.textContent = `៛${(totalUSD * 4100).toFixed(2)}`;
}
renderCartSummary();

// Handle form submit
document.getElementById("checkoutForm").addEventListener("submit", function (e) {
    e.preventDefault();

    if (!cart_list.length) {
        showToast("Your cart is empty.", "error");
        return;
    }

    const form = e.target;
    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;

    const data = {
        first_name: form.first_name.value,
        last_name: form.last_name.value,
        address: form.address.value,
        city: form.city.value,
        country: form.country.value,
        zip: form.zip.value,
        email: form.email.value,
        phone: form.phone.value,
        cart: cart_list
    };

    fetch("/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(resData => {
        if (resData.status === "success") {
            showToast("Order sent successfully!");
            form.reset();
            localStorage.removeItem('cart_list');
            cart_list = [];
            renderCartSummary();
            if (cart) cart.innerText = "Cart(0)";
        } else {
            showToast("Failed to send order: " + (resData.message || "Unknown error"), "error");
        }
    })
    .catch(error => {
        showToast("Error sending order.", "error");
        console.error("Checkout Error:", error);
    })
    .finally(() => {
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}
